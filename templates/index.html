<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live AI - Active Listening</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            padding: 48px 24px;
            background-color: #f3f3f3;
            max-width: 800px;
            margin: auto;
            line-height: 1.5;
            transition: background-color 0.5s ease-in-out;
        }

        #start-listening {
            padding: 12px 24px;
            font-size: 16px;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: white;
            background-color: #6200EA;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            /* transition: all 0.3s ease-in-out; */
        }

        #start-listening:hover {
            background-color: #4A148C;
            transform: scale(1.05);
        }

        #indicator {
            margin: 0;
            font-size: 16px;
            color: #555;
            transition: all 0.3s ease-in-out;
        }

        /* Tab Styles */
        .tabs {
            margin-top: 48px;
            /* background: white; */
            border-radius: 12px;
            overflow: hidden;
            /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); */
        }

        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            padding: 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .tab-button:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        .tab-button.active {
            background-color: white;
            color: #6200EA;
            border-bottom: 3px solid #6200EA;
        }

        .tab-content {
            display: none;
            padding: 24px;
            /* background: white; */
        }

        .tab-content.active {
            display: block;
        }

        /* Content Styles */
        .qa-item {
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }

        .qa-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .qa-item strong {
            display: block;
            margin-bottom: 8px;
            color: #495057;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #6c757d;
            font-style: italic;
        }

        .content-container {
            white-space: normal;
            line-height: 1.6;
        }

        .content-container h1,
        .content-container h2,
        .content-container h3 {
            color: #2c3e50;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .content-container ul,
        .content-container ol {
            padding-left: 24px;
            margin: 24px 0;
        }

        .content-container li {
            margin: 12px 0;
        }

        .content-container p {
            margin: 24px 0;
        }

        .content-container code {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        .content-container pre {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 24px 0;
        }

        .content-container blockquote {
            border-left: 4px solid #6200EA;
            margin: 24px 0;
            padding-left: 24px;
            color: #6c757d;
        }

        .content-container table {
            border-collapse: collapse;
            width: 100%;
            margin: 24px 0;
        }

        .content-container th,
        .content-container td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        .content-container th {
            background: #f8f9fa;
        }

        /* QA specific styles */
        .qa-item .question {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .qa-item .answer {
            color: #495057;
        }

        /* Animation for tab transitions */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            animation: fadeIn 0.3s ease-in;
        }

        /* Add new styles for the button container */
        .button-container {
            display: flex;
            align-items: center;
            gap: 16px;  /* Space between button and text */
        }

        /* Loading spinner and pending state styles */
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6200EA;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .pending-state {
            text-align: center;
            padding: 48px 24px;
            color: #6c757d;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Updated waveform styles */
        .waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 30px;
            margin-left: 12px;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 16px;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease-in-out;
        }

        .waveform.active {
            opacity: 1;
            transform: translateX(0);
        }

        .waveform .bar {
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, #9C27B0, #6200EA);
            border-radius: 2px;
            transform-origin: bottom;
            transform: scaleY(0.1);
            transition: transform 0.05s ease, background 0.3s ease;
        }

        /* Add 15 bars to the waveform div */
        .waveform {
            --bar-count: 15;
        }

        @keyframes glow {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
            100% { filter: brightness(1); }
        }

        /* Refined transition styles */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            padding: 48px 24px;
            background-color: #f3f3f3;
            max-width: 800px;
            margin: auto;
            line-height: 1.5;
            transition: background-color 0.5s ease-in-out;
        }

        #start-listening {
            padding: 12px 24px;
            font-size: 16px;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: white;
            background-color: #6200EA;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        #start-listening:hover {
            background-color: #4A148C;
            transform: scale(1.05);
        }

        #indicator {
            margin: 0;
            font-size: 16px;
            color: #555;
            transition: all 0.3s ease-in-out;
        }

        /* Button container with improved layout */
        .button-container {
            display: flex;
            align-items: center;
            gap: 16px;  /* Space between button and text */
        }

        /* Refined waveform styles */
        .waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 30px;
            margin-left: 12px;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 16px;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease-in-out;
        }

        .waveform.active {
            opacity: 1;
            transform: translateX(0);
        }

        .waveform .bar {
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, #9C27B0, #6200EA);
            border-radius: 2px;
            transform-origin: bottom;
            transform: scaleY(0.1);
            transition: transform 0.05s ease, background 0.3s ease;
        }

        /* Loading spinner and pending state styles */
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6200EA;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .pending-state {
            text-align: center;
            padding: 48px 24px;
            color: #6c757d;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                /* transform: translateY(-10px); */
            }
            to {
                opacity: 1;
                /* transform: translateY(0); */
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                /* transform: translateY(0); */
            }
            to {
                opacity: 0;
                /* transform: translateY(10px); */
            }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .question-header:after {
            content: '';
            position: absolute;
            right: 24px;
            width: 10px;
            height: 10px;
            border-right: 2px solid #6c757d;
            border-bottom: 2px solid #6c757d;
            transform: rotate(45deg);
            transition: transform 0.3s ease;
            margin-top: -5px;
        }

        .qa-item.active .question-header:after {
            transform: rotate(-135deg);
            margin-top: 5px;
        }

        .question-header:hover {
            background-color: #f8f9fa;
        }

        .timestamp {
            color: #999;
            font-size: 14px;
            font-weight: normal;
            min-width: 45px;
            text-align: right;
            margin-right: 32px;  /* Make room for the arrow */
        }

        .question {
            flex: 1;
            margin-right: 16px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
        }

        .answer {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
            /* background-color: #f8f9fa; */
            padding: 0 24px;
            opacity: 0;
        }

        .qa-item.active .answer {
            max-height: 1000px;
            padding: 24px;
            opacity: 1;
            border-top: 1px solid #e9ecef;
        }

        /* Add these new styles */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            flex-shrink: 0;
            margin-bottom: 24px;
        }

        .header h1 {
            margin: 0;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background: white;
            border-radius: 12px;
            margin: 24px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #chat-input {
            position: fixed;
            bottom: 84px; /* Position above bottom controls */
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 48px);
            max-width: 800px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 12px;
        }

        #user-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }

        #send-btn {
            padding: 12px 24px;
            background: #6200EA;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .message {
            margin-bottom: 16px;
            max-width: 80%;
        }

        .message.user {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 12px;
        }

        .user .message-content {
            background: #6200EA;
            color: white;
        }

        .assistant .message-content {
            background: #f0f0f0;
        }

        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Add these new styles */
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            height: 44px;
            margin-left: auto;
        }

        .tab-button {
            padding: 0 24px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }

        .tab-button.active {
            background: #6200EA;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .qa-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            background: #f8f9fa;
        }

        .timestamp {
            color: #6c757d;
            font-size: 14px;
        }

        .answer {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .qa-item.active .answer {
            padding: 16px;
            max-height: 1000px;
        }

        /* Bottom controls styling */
        .bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            /* background: white; */
            /* box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); */
            padding: 16px;
        }

        .controls-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 0 24px;
        }

        .button-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        #start-listening {
            height: 44px;
            padding: 0 24px;
            font-size: 16px;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: white;
            background-color: #6200EA;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        #indicator {
            color: #6c757d;
            font-size: 14px;
            white-space: nowrap;
        }

        /* Adjust main content area to account for bottom controls */
        #chat-messages, #qa-list {
            margin-bottom: 100px; /* Add space for bottom controls */
        }

        .waveform {
            height: 44px;
            padding: 8px;
        }

        /* Ensure content doesn't get hidden behind fixed elements */
        #chat-view, #qa-view {
            padding-bottom: 160px; /* Account for both chat input and bottom controls */
        }

        /* Add new transcript styles */
        #transcript-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
        }

        .transcript-line {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        .transcript-bubble {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .transcript-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            color: #64748b;
            padding: 0 8px;
        }

        .transcript-time {
            font-weight: 500;
        }

        .transcript-confidence {
            padding: 2px 6px;
            background: #f1f5f9;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div class="header">
            <h1>Pai</h1>
        </div>

        <div id="chat-view" class="tab-content active">
            <div id="chat-messages">
                <div class="empty-state">Start a conversation with Pai!</div>
            </div>

            <div id="chat-input">
                <input type="text" id="user-input" placeholder="Ask a question..." />
                <button id="send-btn">Send</button>
            </div>
        </div>

        <div id="qa-view" class="tab-content">
            <div id="qa-list">
                <!-- Auto-detected Q&A pairs will appear here -->
                <div class="empty-state">No questions detected yet.</div>
            </div>
        </div>

        <div id="transcript-view" class="tab-content">
            <div id="transcript-messages">
                <div class="empty-state">
                    <div class="empty-icon">üéôÔ∏è</div>
                    <h3>No Transcript Yet</h3>
                    <p>Start recording to see the conversation appear here</p>
                </div>
            </div>
        </div>

        <div class="bottom-controls">
            <div class="controls-wrapper">
                <div class="button-container">
                    <button id="start-listening">Let Pai Listen</button>
                    <div class="waveform" id="waveform"></div>
                </div>
                <div id="indicator">Click to start transcription.</div>
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="chat-view">Chat</button>
                    <button class="tab-button" data-tab="qa-view">Q&A</button>
                    <button class="tab-button" data-tab="transcript-view">Transcript</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isListening = false;
        let audioContext;
        let analyser;
        let dataArray;
        let source;
        let animationFrame;
        const socket = io();

        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            sanitize: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Safely convert markdown to HTML
        function renderMarkdown(content) {
            try {
                return marked.parse(content);
            } catch (e) {
                console.error('Markdown parsing error:', e);
                return content;
            }
        }

        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => 
                    btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => 
                    content.classList.remove('active'));
                
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');

                if (tabId === 'qa-view') {
                    fetchQuestions();
                } else if (tabId === 'transcript-view') {
                    fetchTranscript();
                }
            });
        });

        // Listen for content updates
        socket.on('content_update', function() {
            console.log("Received content update event");
            const transcriptTab = document.querySelector('[data-tab="transcript-view"]');
            // Always fetch new transcript data when we get an update, regardless of active tab
            fetchTranscript();
        });

        // Add these new functions to show/hide loading state
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="pending-state">
                    <div class="loading-spinner"></div>
                    <p>Generating content...</p>
                </div>
            `;
        }

        function fetchQuestions() {
            showLoading("qa-list");
            fetch("/get-questions")
                .then(response => response.json())
                .then(data => {
                    const qaList = document.getElementById("qa-list");
                    if (data.questions && data.questions.length > 0) {
                        qaList.innerHTML = "";
                        data.questions.forEach((item, index) => {
                            const questionEl = document.createElement("div");
                            questionEl.className = "qa-item";
                            
                            // Add 'active' class to most recent question
                            if (index === 0) {
                                questionEl.classList.add('active');
                            }
                            
                            questionEl.innerHTML = `
                                <div class="question-header">
                                    <div class="question">${item.question}</div>
                                    <div class="timestamp">${item.timestamp || "00:00"}</div>
                                </div>
                                <div class="answer">${renderMarkdown(item.answer)}</div>
                            `;

                            questionEl.querySelector('.question-header').addEventListener('click', () => {
                                questionEl.classList.toggle('active');
                            });

                            qaList.appendChild(questionEl);
                        });
                    } else {
                        qaList.innerHTML = '<div class="empty-state">No questions detected yet.</div>';
                    }
                })
                .catch(error => {
                    console.error("Error fetching questions:", error);
                    document.getElementById("qa-list").innerHTML = '<div class="empty-state">Error loading questions.</div>';
                });
        }

        function formatTimestamp(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) {
                return "00:00";
            }
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function fetchMeetingMinutes() {
            showLoading("meeting-minutes");
            fetch("/get-meeting-minutes")
                .then(response => response.json())
                .then(data => {
                    const minutesEl = document.getElementById("meeting-minutes");
                    if (data.meeting_minutes && data.meeting_minutes.trim()) {
                        minutesEl.innerHTML = renderMarkdown(data.meeting_minutes);
                    } else {
                        minutesEl.innerHTML = '<div class="empty-state">No meeting minutes generated yet.</div>';
                    }
                })
                .catch(error => {
                    console.error("Error fetching meeting minutes:", error);
                    document.getElementById("meeting-minutes").innerHTML = '<div class="empty-state">Error loading meeting minutes.</div>';
                });
        }

        function createBars() {
            const waveform = document.getElementById('waveform');
            waveform.innerHTML = ''; // Clear existing bars
            const barCount = 15; // Must be odd number for center symmetry
            
            // Create bars in order from center outward
            const centerIndex = Math.floor(barCount / 2);
            
            // Create center bar first
            const centerBar = document.createElement('div');
            centerBar.className = 'bar';
            centerBar.dataset.position = '0';
            waveform.appendChild(centerBar);
            
            // Create pairs of bars moving outward
            for (let i = 1; i <= centerIndex; i++) {
                // Create left bar
                const leftBar = document.createElement('div');
                leftBar.className = 'bar';
                leftBar.dataset.position = `-${i}`;
                
                // Create right bar
                const rightBar = document.createElement('div');
                rightBar.className = 'bar';
                rightBar.dataset.position = `${i}`;
                
                // Insert at beginning and end respectively
                waveform.insertBefore(leftBar, waveform.firstChild);
                waveform.appendChild(rightBar);
            }
        }

        function visualizeAudio(stream) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 512; // Increased for more detailed frequency data
            analyser.smoothingTimeConstant = 0.8;
            
            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function updateWaveform() {
                if (!isListening) {
                    if (animationFrame) {
                        cancelAnimationFrame(animationFrame);
                    }
                    return;
                }

                analyser.getByteFrequencyData(dataArray);
                
                const bars = document.querySelectorAll('.waveform .bar');
                const barCount = bars.length;
                const bucketSize = Math.floor(dataArray.length / barCount);
                
                let maxValue = 0;
                const centerIndex = Math.floor(barCount / 2);
                
                // Process bars based on their position from center
                bars.forEach((bar) => {
                    const position = parseInt(bar.dataset.position);
                    const distanceFromCenter = Math.abs(position);
                    
                    // Calculate the data index based on distance from center
                    const dataIndex = (centerIndex + position) * bucketSize;
                    let sum = 0;
                    
                    // Get average of frequency range
                    for (let i = 0; i < bucketSize; i++) {
                        sum += dataArray[(dataIndex + i) % dataArray.length];
                    }
                    const average = sum / bucketSize;
                    maxValue = Math.max(maxValue, average);
                    
                    // Add slight delay based on distance from center
                    const delay = distanceFromCenter * 0.1;
                    const scale = 0.1 + (average / 256) * 1.5 * Math.max(0, 1 - delay);
                    const hue = 120 + (average / 256) * 60;
                    
                    bar.style.transform = `scaleY(${scale})`;
                    bar.style.background = `linear-gradient(to bottom, 
                        hsl(${hue}, 70%, 60%), 
                        hsl(${hue + 20}, 90%, 40%))`;
                    
                    // Add glow effect for loud sounds
                    if (average > 200) {
                        bar.style.animation = 'glow 0.5s ease infinite';
                    } else {
                        bar.style.animation = 'none';
                    }
                });
                
                // Make waveform container glow on high volumes
                const waveform = document.getElementById('waveform');
                if (maxValue > 200) {
                    waveform.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                } else {
                    waveform.style.boxShadow = 'none';
                }
                
                animationFrame = requestAnimationFrame(updateWaveform);
            }
            
            updateWaveform();
        }

        async function startListening(button, indicator, waveform) {
            try {
                createBars();
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Start transition
                button.style.backgroundColor = "#9C27B0";
                document.body.style.backgroundColor = "#F3E5F5";
                
                // Animate the state changes
                await Promise.all([
                    animateElement(button, {
                        textContent: "Pause Pai",
                        backgroundColor: "#9C27B0"
                    }),
                    animateElement(indicator, {
                        textContent: "Listening ... Transcribing in progress.",
                        color: "#9C27B0"
                    })
                ]);

                // Show waveform with animation
                waveform.classList.add('active');
                
                visualizeAudio(stream);
                await fetch("/start-listening", { method: "POST" });
            } catch (err) {
                console.error("Error accessing microphone:", err);
                isListening = false;
                await animateElement(indicator, {
                    textContent: "Error accessing microphone.",
                    color: "red"
                });
            }
        }

        async function stopListening(button, indicator, waveform) {
            // Animate state changes
            waveform.classList.remove('active');
            
            await Promise.all([
                animateElement(button, {
                    textContent: "Let Pai Listen",
                    backgroundColor: "#6200EA"
                }),
                animateElement(indicator, {
                    textContent: "Transcription stopped.",
                    color: "#555"
                })
            ]);

            // Cleanup audio
            if (source) {
                source.disconnect();
            }
            if (audioContext) {
                await audioContext.suspend();
            }
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }

            document.body.style.backgroundColor = "#f3f3f3";
            await fetch("/stop-listening", { method: "POST" });
        }

        // Helper function for smooth text/color transitions
        function animateElement(element, properties) {
            return new Promise(resolve => {
                const duration = 300; // match CSS transition duration
                
                if (properties.textContent) {
                    element.style.animation = 'fadeOut 0.15s ease-out';
                    
                    setTimeout(() => {
                        element.textContent = properties.textContent;
                        element.style.animation = 'fadeIn 0.15s ease-in';
                    }, 150);
                }

                if (properties.backgroundColor) {
                    element.style.backgroundColor = properties.backgroundColor;
                }

                if (properties.color) {
                    element.style.color = properties.color;
                }

                setTimeout(resolve, duration);
            });
        }

        document.getElementById("start-listening").addEventListener("click", async function () {
            const button = this;
            const indicator = document.getElementById("indicator");
            const waveform = document.getElementById("waveform");

            isListening = !isListening;

            if (isListening) {
                await startListening(button, indicator, waveform);
            } else {
                await stopListening(button, indicator, waveform);
            }
        });

        // Chat functionality
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-btn');

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${isUser ? content : renderMarkdown(content)}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleSendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, true);
            userInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                addMessage(data.response);
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, there was an error processing your message.', false);
            }
        }

        // Event listeners for sending messages
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // Add this to your existing JavaScript
        function fetchTranscript() {
            fetch("/get-transcript")
                .then(response => response.json())
                .then(data => {
                    const transcriptContainer = document.getElementById("transcript-messages");
                    if (data.lines && data.lines.length > 0) {
                        // Only update if we have new content
                        const newContent = data.lines.map(line => {
                            const timestampMatch = line.match(/\(Time Stamp: ([\d:]+)\)/);
                            const timestamp = timestampMatch ? timestampMatch[1] : "00:00";
                            
                            // Clean the text (remove metadata)
                            const cleanText = line
                                .replace(/\(Time Stamp: [\d:]+\)/, '')
                                .replace(/\(Confidence: [\d.]+\)/, '')
                                .trim();

                            return `
                                <div class="transcript-line" style="animation: fadeIn 0.3s ease-out">
                                    <div class="transcript-meta">
                                        <span class="transcript-time">${timestamp}</span>
                                    </div>
                                    <div class="transcript-bubble">
                                        ${cleanText}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        transcriptContainer.innerHTML = newContent;
                        
                        // Scroll to bottom for new content
                        transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
                    }
                })
                .catch(error => console.error("Error fetching transcript:", error));
        }
    </script>
</body>
</html>